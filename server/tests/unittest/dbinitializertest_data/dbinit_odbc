CREATE TABLE SchemaVersionTable (version INTEGER NOT NULL DEFAULT 0)

CREATE TABLE ResourceTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                            name VARCHAR(255) NOT NULL UNIQUE,
                            isVirtual CHAR DEFAULT 0)

CREATE TABLE CollectionTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                              remoteId VARCHAR(255),
                              remoteRevision VARCHAR(255),
                              name VARCHAR(255) NOT NULL,
                              parentId BIGINT REFERENCES CollectionTable(id) ON DELETE CASCADE ON UPDATE CASCADE,
                              resourceId BIGINT NOT NULL REFERENCES ResourceTable(id) ON DELETE CASCADE ON UPDATE CASCADE,
                              subscribed CHAR NOT NULL DEFAULT 1,
                              cachePolicyInherit CHAR NOT NULL DEFAULT 1,
                              cachePolicyCheckInterval INTEGER NOT NULL DEFAULT -1,
                              cachePolicyCacheTimeout INTEGER NOT NULL DEFAULT -1,
                              cachePolicySyncOnDemand CHAR NOT NULL DEFAULT 0,
                              cachePolicyLocalParts VARCHAR(255),
                              queryString VARCHAR(32768),
                              queryLanguage VARCHAR(255))

CREATE UNIQUE INDEX CollectionTable_parentAndNameIndex ON CollectionTable (parentId,name)

CREATE TABLE MimeTypeTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                            name VARCHAR(255) NOT NULL UNIQUE)

CREATE TABLE PimItemTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                           rev INTEGER NOT NULL DEFAULT 0,
                           remoteId VARCHAR(255),
                           remoteRevision VARCHAR(255),
                           collectionId BIGINT REFERENCES CollectionTable(id) ON DELETE CASCADE ON UPDATE CASCADE,
                           mimeTypeId BIGINT REFERENCES MimeTypeTable(id) ON DELETE CASCADE ON UPDATE CASCADE,
                           datetime TIMESTAMP,
                           atime TIMESTAMP,
                           dirty CHAR,
                           size BIGINT NOT NULL DEFAULT 0)

CREATE INDEX PimItemTable_collectionIndex ON PimItemTable (collectionId)

CREATE TABLE FlagTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                        name VARCHAR(255) NOT NULL UNIQUE)

CREATE TABLE PartTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                        pimItemId BIGINT NOT NULL REFERENCES PimItemTable(id) ON DELETE CASCADE ON UPDATE CASCADE,
                        name VARCHAR(255) NOT NULL,
                        data LONG VARCHAR,
                        datasize BIGINT NOT NULL,
                        version INTEGER DEFAULT 0,
                        external CHAR DEFAULT 0)

CREATE UNIQUE INDEX PartTable_pimItemIdNameIndex ON PartTable (pimItemId,name)

CREATE INDEX PartTable_pimItemNameIndex ON PartTable (name)

CREATE TABLE CollectionAttributeTable (id BIGINT NOT NULL IDENTITY PRIMARY KEY,
                                       collectionId BIGINT NOT NULL REFERENCES CollectionTable(id) ON DELETE CASCADE ON UPDATE CASCADE,
                                       type LONG VARCHAR NOT NULL,
                                       value LONG VARCHAR)

CREATE INDEX CollectionAttributeTable_collectionIndex ON CollectionAttributeTable (collectionId)

CREATE TABLE PimItemFlagRelation (PimItem_id INTEGER REFERENCES PimItemTable(id),
                                  Flag_id INTEGER REFERENCES FlagTable(id), PRIMARY KEY (PimItem_id, Flag_id))

CREATE TABLE CollectionMimeTypeRelation (Collection_id INTEGER REFERENCES CollectionTable(id),
                                         MimeType_id INTEGER REFERENCES MimeTypeTable(id), PRIMARY KEY (Collection_id, MimeType_id))

CREATE TABLE CollectionPimItemRelation (Collection_id INTEGER REFERENCES CollectionTable(id),
                                        PimItem_id INTEGER REFERENCES PimItemTable(id), PRIMARY KEY (Collection_id, PimItem_id))
